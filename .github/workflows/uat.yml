name: UAT Component Tests

on:
  pull_request: #TODO: change it back to push?
    branches:
      - main

jobs:
  uat-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - category: component
            timeout: 1000
          - category: deployment
            timeout: 3900
          - category: fleet-status
            timeout: 1000
          - category: runtime
            timeout: 1000
          - category: security
            timeout: 1500
    permissions:
      id-token: write
      contents: read

    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ">=3.12"

      - name: Checkout testing repository
        uses: actions/checkout@v4
        with:
          repository: felicityzhao9/aws-greengrass-testing #TODO: need to change
          ref: python_testing
          path: aws-greengrass-testing

      - name: Get temporary AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          audience: sts.amazonaws.com
          aws-region: us-west-2
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-duration-seconds: ${{ matrix.timeout }}
          unset-current-credentials: true

      - name: Set sanitized SHA to github env
        env:
          PR_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          SANITIZED_SHA=$(echo "$PR_SHA" | tr -cd 'a-fA-F0-9')
          echo "SHA=$SANITIZED_SHA" >> $GITHUB_ENV

      - name: Run UAT tests
        run: |
          cd aws-greengrass-testing

          ./run-tests.sh \
            --aws-account="${{ secrets.AWS_ACCOUNT_ID }}" \
            --s3-bucket="${{ secrets.S3_BUCKET }}" \
            --commit-id="${{ env.SHA }}" \
            --aws-region="us-west-2" \
            --test-category="${{ matrix.category }}"

      - name: Collect critical Greengrass logs
        if: always()
        run: |
          mkdir -p system-logs

          critical_services=(
            "ggl.core.gg-fleet-statusd.service"
            "ggl.core.ggconfigd.service"
            "ggl.core.ggdeploymentd.service"
            "ggl.core.gghealthd.service"
            "ggl.core.ggipcd.service"
            "ggl.core.ggpubsubd.service"
            "ggl.core.iotcored.service"
            "ggl.core.tesd.service"
          )

          # Collect individual service logs
          for service in "${critical_services[@]}"; do
            sudo journalctl -xeau "$service" --no-pager --output=short-full --lines=all | sed 's/\x1b\[[0-9;]*m//g' > "system-logs/${service}.log"
          done

          # Unified logs
          sudo journalctl -xeau --no-pager --output=short-full --lines=all -u "ggl.*" | sed 's/\x1b\[[0-9;]*m//g' > system-logs/all-ggl-services.log 2>/dev/null || echo "No GGL services found"

      - name: Upload Greengrass logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ggl-logs-${{ matrix.category }}-${{ github.run_id }}
          path: system-logs/
          retention-days: 7
          if-no-files-found: warn